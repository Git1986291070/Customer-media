<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>客户媒体播放器</title>

  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      cursor: pointer;
    }

    .container {
      width: 90%;
      max-width: 800px;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .title {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #333;
    }

    .audio-player {
      width: 100%;
      margin: 20px auto;
      display: none;
    }

    .image-container {
      width: 100%;
      margin: 20px auto;
      display: none;
      text-align: center;
    }

    .customer-image {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .video-container {
      width: 100%;
      margin: 20px auto;
      display: none;
      text-align: center;
    }

    .customer-video {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .status-message {
      margin-top: 15px;
      font-size: 0.9em;
      color: #666;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .overlay-message {
      font-size: 24px;
      color: #333;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px 40px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .error-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8d7da;
      color: #721c24;
      border-radius: 4px;
      display: none;
    }

    .hidden {
      display: none;
    }

    .loading {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .customer-info {
      margin: 20px 0;
      padding: 15px;
      background-color: #e9f7fe;
      border-radius: 4px;
      text-align: left;
    }

    .customer-info p {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <!-- 全屏覆盖层，用于捕获任何交互 -->
  <div id="interaction-overlay" class="overlay">
    <div class="overlay-message">点击任意位置或移动鼠标开始加载媒体</div>
  </div>

  <div class="container">
    <h1 class="title">客户媒体</h1>

    <!-- 加载动画 -->
    <div id="loading" class="loading"></div>

    <!-- 客户信息 -->
    <div id="customer-info" class="customer-info hidden">
      <p id="customer-id-display">客户编号: </p>
      <p id="customer-name">客户名称: </p>
      <p id="media-type">媒体类型: </p>
    </div>

    <!-- 音频播放器 -->
    <audio id="audio-player" class="audio-player" controls></audio>

    <!-- 图片容器 -->
    <div id="image-container" class="image-container">
      <img id="customer-image" class="customer-image" alt="客户图片">
    </div>

    <!-- 视频容器 -->
    <div id="video-container" class="video-container">
      <video id="customer-video" class="customer-video" controls></video>
    </div>

    <!-- 状态信息 -->
    <div id="status-message" class="status-message">等待页面交互...</div>

    <!-- 错误信息 -->
    <div id="error-container" class="error-container">
      未提供有效的客户编号。请使用格式：<br>
      <code>?customer=123456</code>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const audioPlayer = document.getElementById('audio-player');
      const customerImage = document.getElementById('customer-image');
      const imageContainer = document.getElementById('image-container');
      const customerVideo = document.getElementById('customer-video');
      const videoContainer = document.getElementById('video-container');
      const statusMessage = document.getElementById('status-message');
      const interactionOverlay = document.getElementById('interaction-overlay');
      const errorContainer = document.getElementById('error-container');
      const loading = document.getElementById('loading');
      const customerInfo = document.getElementById('customer-info');
      const customerIdDisplay = document.getElementById('customer-id-display');
      const customerName = document.getElementById('customer-name');
      const mediaType = document.getElementById('media-type');

      // 隐藏加载动画
      loading.classList.add('hidden');

      // 从URL参数获取客户编号
      function getCustomerIdFromParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('customer');
      }

      // 构建OSS配置文件URL
      function buildConfigUrl(customerId) {
        // 这里替换为实际的OSS基础URL
        const ossBaseUrl = 'https://ziliaocunfang.oss-cn-guangzhou.aliyuncs.com';
        return `${ossBaseUrl}/configs/${customerId}.json`;
      }

      // 获取客户编号
      const customerId = getCustomerIdFromParams();
      console.log('获取到的客户编号:', customerId);




      // 检查客户编号是否有效
      if (!customerId) {
        statusMessage.textContent = "错误：未提供客户编号";
        errorContainer.style.display = 'block';
        interactionOverlay.classList.add('hidden');
        loading.classList.add('hidden');
        return;
      }

      // 更新客户ID显示
      customerIdDisplay.textContent = `客户编号: ${customerId}`;

      // 标记是否已经加载
      let hasLoaded = false;

      // 加载配置并处理媒体
      function loadCustomerMedia() {
        if (hasLoaded) return; // 防止重复加载
        hasLoaded = true;

        // 隐藏覆盖层
        interactionOverlay.classList.add('hidden');

        // 显示加载动画
        loading.classList.remove('hidden');

        statusMessage.textContent = "正在加载客户配置...";

        // 构建配置URL
        const configUrl = buildConfigUrl(customerId);
        console.log('构建的配置文件URL:', configUrl);

        // 获取配置文件
        fetch(configUrl)
          .then(response => {
            if (!response.ok) {
              return response.text().then(text => {
        throw new Error(`HTTP error! Status: ${response.status}, Response body: ${text}`);
      });
            }
            console.log("配置加载成功:", response);
            return response.json();
          })
          .then(config => {
            // 处理配置
            processConfig(config);
          })
          .catch(error => {
            console.error("配置加载错误:", error);
    console.error("请求的配置文件 URL:", configUrl);
    if (error.response) {
    error.response.text().then(text => console.error("服务器响应内容:", text));
  }
  statusMessage.textContent = `无法加载客户配置，错误信息: ${error.message}`;
  errorContainer.style.display = 'block';
  loading.classList.add('hidden');
          });
      }

      // 处理配置文件
      function processConfig(config) {
        // 隐藏加载动画
        loading.classList.add('hidden');

        // 显示客户信息
        customerInfo.classList.remove('hidden');

        // 更新客户信息
        if (config.customerName) {
          customerName.textContent = `客户名称: ${config.customerName}`;
        }

        // 根据媒体类型处理
        if (config.mediaType === 'audio') {
          mediaType.textContent = `媒体类型: 音频`;
          handleAudio(config);
        } else if (config.mediaType === 'image') {
          mediaType.textContent = `媒体类型: 图片`;
          handleImage(config);
        } else if (config.mediaType === 'video') {
          mediaType.textContent = `媒体类型: 视频`;
          handleVideo(config);
        } else {
          statusMessage.textContent = `不支持的媒体类型: ${config.mediaType}`;
        }
      }

      // 处理音频
      function handleAudio(config) {
        if (!config.mediaUrl) {
          statusMessage.textContent = "配置中未找到音频URL";
          return;
        }

        // 显示音频播放器
        audioPlayer.style.display = 'block';

        // 设置音频源
        audioPlayer.src = config.mediaUrl;

        // 预加载音频
        audioPlayer.load();

        // 隐藏加载动画
        loading.classList.add('hidden');

        statusMessage.textContent = "音频已加载，准备播放...";

        // 尝试自动播放
        playAudio();
      }

      // 处理图片
      function handleImage(config) {
        if (!config.mediaUrl) {
          statusMessage.textContent = "配置中未找到图片URL";
          return;
        }

        // 显示图片容器
        imageContainer.style.display = 'block';

        // 设置图片源
        customerImage.src = config.mediaUrl;

        // 设置图片alt文本
        if (config.mediaAlt) {
          customerImage.alt = config.mediaAlt;
        } else {
          customerImage.alt = config.customerName ? `${config.customerName}的图片` : '客户图片';
        }

        // 隐藏加载动画
        loading.classList.add('hidden');

        statusMessage.textContent = "图片已加载";
      }

      // 处理视频
      function handleVideo(config) {
        if (!config.mediaUrl) {
          statusMessage.textContent = "配置中未找到视频URL";
          return;
        }

        // 显示视频容器
        videoContainer.style.display = 'block';

        // 设置视频源
        customerVideo.src = config.mediaUrl;
        
        // 设置视频属性
        if (config.poster) {
          customerVideo.poster = config.poster;
        }
        
        if (config.autoplay) {
          customerVideo.autoplay = true;
          customerVideo.muted = true; // 必须静音才能自动播放
        }
        
        // 预加载视频
        customerVideo.load();
        
        // 隐藏加载动画
        loading.classList.add('hidden');
        
        statusMessage.textContent = "视频已加载，准备播放...";
        
        // 尝试自动播放
        playVideo();
      }

      // 播放音频
      function playAudio() {
        // 只有当音频元素可见时才尝试播放
        if (audioPlayer.style.display !== 'block') return;

        statusMessage.textContent = "正在尝试播放音频...";

        // 尝试播放
        audioPlayer.play().then(() => {
          statusMessage.textContent = "音频播放中...";
        }).catch(error => {
          console.error("播放错误:", error);
          statusMessage.textContent = "自动播放失败，请点击播放按钮手动播放";
        });
      }

      // 播放视频
      function playVideo() {
        // 只有当视频元素可见时才尝试播放
        if (videoContainer.style.display !== 'block') return;
        
        statusMessage.textContent = "正在尝试播放视频...";
        
        // 尝试播放
        customerVideo.play().then(() => {
          statusMessage.textContent = "视频播放中...";
          
          // 如果是自动播放且静音，尝试在播放后取消静音
          setTimeout(() => {
            if (customerVideo.muted) {
              customerVideo.muted = false;
              statusMessage.textContent = "已取消静音，视频正常播放中...";
            }
          }, 1000);
        }).catch(error => {
          console.error("视频播放错误:", error);
          statusMessage.textContent = "自动播放失败，请点击播放按钮手动播放";
        });
      }

      // 监听各种交互事件
      const interactionEvents = [
        'click', 'touchstart', 'touchend', 'mousemove', 'mousedown', 'keydown', 'scroll'
      ];

      // 为每种交互添加监听器
      interactionEvents.forEach(eventType => {
        document.addEventListener(eventType, loadCustomerMedia, { once: true });
      });

      // 覆盖层点击事件
      interactionOverlay.addEventListener('click', loadCustomerMedia);

      // 音频播放器事件
      audioPlayer.addEventListener('playing', function () {
        statusMessage.textContent = "音频播放中...";
      });

      audioPlayer.addEventListener('ended', function () {
        statusMessage.textContent = "播放结束";
      });

      audioPlayer.addEventListener('error', function () {
        const errorCode = audioPlayer.error ? audioPlayer.error.code : "unknown";
        console.error("音频错误:", errorCode);
        statusMessage.textContent = `播放错误 (${errorCode})。可能是音频链接已过期或不可用。`;
      });

      // 图片加载事件
      customerImage.addEventListener('load', function () {
        statusMessage.textContent = "图片加载完成";
      });

      customerImage.addEventListener('error', function () {
        statusMessage.textContent = "图片加载失败，请检查URL是否有效";
      });

      // 视频事件
      customerVideo.addEventListener('playing', function () {
        statusMessage.textContent = "视频播放中...";
      });
      
      customerVideo.addEventListener('ended', function () {
        statusMessage.textContent = "视频播放结束";
      });
      
      customerVideo.addEventListener('error', function () {
        const errorCode = customerVideo.error ? customerVideo.error.code : "unknown";
        console.error("视频错误:", errorCode);
        statusMessage.textContent = `视频播放错误 (${errorCode})。可能是视频链接已过期或不可用。`;
      });

      // 定时尝试加载
      setInterval(() => {
        if (!hasLoaded) {
          loadCustomerMedia();
        } else if (audioPlayer.style.display === 'block' && audioPlayer.paused) {
          // 如果是音频且未播放，尝试播放
          playAudio();
        } else if (videoContainer.style.display === 'block' && customerVideo.paused) {
          // 如果是视频且未播放，尝试播放
          playVideo();
        }
      }, 1000);
    });
  </script>

</body>

</html>
